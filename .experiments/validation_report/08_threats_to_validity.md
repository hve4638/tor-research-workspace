# Threats to Validity

**Document version**: 1.0
**Date**: 2025-02-23
**Scope**: Systematic analysis of threats to internal, external, construct, and statistical conclusion validity for the AS-level Tor traffic correlation reproduction experiments.

---

## 1. Introduction

This document follows the standard four-category validity threat taxonomy (Cook & Campbell, 1979; Wohlin et al., 2012) applied to our reproduction of the RAPTOR (Sun et al., 2015) and Johnson et al. (2013) papers. Each threat is assessed for its potential impact on our conclusions, with specific references to the claim classification in `01_validity_framework.md` and the gap analysis in `07_gap_analysis.md`.

---

## 2. Internal Validity

Internal validity concerns whether the observed causal relationships in our experiments are genuine, or whether confounding factors could produce the same results.

### 2.1 Single Random Seed

**Threat**: All experiments use a single random seed (seed 42 for RAPTOR, default for Johnson et al.), meaning all stochastic processes (client placement, relay selection, circuit construction, guard assignment) follow a single realization of the random process.

**Potential impact**: Observed metrics may reflect seed-specific properties rather than general system behavior. For example:
- The 1.003x asymmetric routing factor (B2) could be an artifact of the specific client-to-AS assignments generated by seed 42. A different seed might produce 0.99x or 1.05x.
- The temporal churn trend (B1) could be amplified or dampened by seed-specific guard-client pairings that happen to traverse ASes affected by the January-July 2025 churn events.
- The 1.84x state-level attack spike (B3) depends on which clients' circuits traverse AS3320 and AS6939 under seed 42.

**Affected claims**: All claims, but especially Tier B (B1, B2, B3) where effect sizes are small enough to be within seed-to-seed variance.

**Mitigation**: Multi-seed simulations (S1: 5 seeds for RAPTOR, S2: 5 seeds for Johnson et al.) are planned. Validation scripts V1-V4 will compute per-seed metrics and report means with DKW confidence intervals. Tier A claims with large effect sizes (e.g., Astoria's 99.97% reduction) are expected to be robust across seeds.

### 2.2 Deterministic BFS Routing

**Threat**: Our BFS-based AS path computation is deterministic given a fixed topology: for any source-destination pair, BFS always returns the same path. This means all circuits between the same client AS and exit AS traverse identical transit ASes within a topology snapshot.

**Potential impact**:
- **Overestimation of correlation persistence**: Once a client-exit pair is correlated (or not), it remains so for the entire snapshot period. Real BGP has stochastic elements (route flaps, load balancing, ECMP) that would cause some circuits to be correlated and others not, even for the same source-destination pair.
- **Underestimation of path diversity**: BFS returns a single shortest path, but real BGP may distribute traffic across multiple nearly-equal paths (ECMP). This could either increase or decrease correlation depending on whether alternative paths traverse the same transit ASes.

**Affected claims**: B1 (temporal churn may appear more step-like than gradual), B2 (asymmetry effects are binary per AS-pair rather than probabilistic).

**Mitigation**: The deterministic nature of BFS is partially offset by the stochastic relay selection process: different circuits select different guard/middle/exit relays (and thus different AS pairs), providing path diversity across circuits even if individual AS-pair paths are fixed. Multi-snapshot temporal simulation (7 CAIDA snapshots) introduces path changes over time.

### 2.3 Simplified Guard Selection Model

**Threat**: Our guard selection model uses bandwidth-weighted random selection with a fixed lifetime drawn from U(30, 60) days. Real Tor guard selection (since 2018) involves:
- Primary guards with minimum 120-day lifetime
- Fallback to secondary guards upon primary failure
- Guard stability based on consensus participation history
- NumEntryGuards = 1 (since Tor 0.3.0)

**Potential impact**:
- **CDF shape distortion**: The step function at day 57-60 (A1) differs from the gradual S-curve in the original paper. This affects the time distribution of first compromise events but not the endpoint (100% eventual compromise).
- **Guard concentration**: Real Tor's single primary guard means a client's guard choice is stable for much longer periods (months), potentially increasing the impact of guard-targeted attacks.

**Affected claims**: A1 (CDF shape only, not final compromise rate).

**Mitigation**: Simulation S3 will use variable guard lifetimes (exponential with mean 90 days) matching post-2018 Tor behavior. The endpoint results (100% compromise, 9.47% circuit compromise) are unaffected by this threat.

### 2.4 Circuit Construction Independence

**Threat**: Our simulator constructs circuits independently: each circuit's guard/middle/exit selection is independent of all other circuits. Real Tor reuses guards across circuits and has circuit reuse policies (streams share circuits, max circuit dirtiness = 600 seconds).

**Potential impact**:
- Circuit-level correlation rates may slightly overestimate independence of compromise events. If a client's guard is compromised, all circuits using that guard are compromised simultaneously, creating correlated rather than independent events.
- This is partially modeled (guard persistence across circuit lifetime) but the independence of circuit construction beyond guard selection may underestimate burst correlation patterns.

**Affected claims**: Minimal impact on aggregate rates (A2, B1); affects per-client temporal patterns.

**Mitigation**: Our simulator does model guard persistence within the guard lifetime window. The max_dirtiness parameter is set to 600 seconds matching Tor's default. The primary independence assumption is in middle/exit selection, which is consistent with Tor's actual behavior.

---

## 3. External Validity

External validity concerns whether our findings generalize beyond the specific experimental setup.

### 3.1 Reduced Topology Scale

**Threat**: Our 727-AS Tor-relevant subgraph is 66x smaller than the full Internet AS topology used by RAPTOR (~48,000 ASes). This is the most significant threat to external validity.

**Potential impact**:
- **Path length reduction**: Average AS path length drops from 4-7 hops (full Internet) to 2-4 hops (our graph), reducing transit AS observation opportunities by approximately 40-60%.
- **Transit diversity loss**: With ~6,200 edges vs. ~150,000+, there are fewer alternative routes. A transit AS that appears on 60% of paths in our topology might appear on only 10% in the full Internet, fundamentally changing the distribution of observation capabilities.
- **Attack surface compression**: BGP attacks targeting a single AS affect proportionally more of the small topology (0.14% per target) than the full Internet (0.002% per target).
- **Peer path accuracy**: Studies show BFS/valley-free routing agrees with actual BGP paths for ~70-80% of customer-provider relationships but only ~40-50% of peer relationships. Our Tor-relevant subgraph has a higher proportion of peering (European hosting providers), amplifying path accuracy concerns.

**Affected claims**: C1 (interception not reproduced), C2 (absolute values 5-50x lower), B2 (asymmetric routing magnitude insufficient).

**Mitigation**:
1. All claims are framed as relative comparisons rather than absolute values.
2. Validation scripts quantify path length distributions and transit AS reachability to establish scaling relationships.
3. The close match of Johnson et al. baseline (~2% paper vs. 1.93% ours) suggests that for within-topology comparisons, results are valid.

### 3.2 Missing IXP Layer

**Threat**: Internet Exchange Points are not modeled. IXPs provide:
- Direct observation capability for the IXP operator (comparable to a Tier-1 transit AS in some regions)
- Shortcut paths that bypass transit providers, altering which ASes observe traffic
- A growing share of Internet interconnection (particularly in Europe where Tor relays are concentrated)

**Potential impact**:
- **Threat ranking distortion**: DE-CIX (Frankfurt), AMS-IX (Amsterdam), and LINX (London) connect hundreds of ASes hosting Tor relays. An IXP operator at these locations could potentially observe more Tor traffic than some Tier-1 transit providers, which would disrupt the Tier-1 dominance finding (A3).
- **Defense effectiveness change**: Astoria's defense (avoiding transit AS overlap) does not account for IXP observation. If IXP observation is significant, Astoria's effectiveness could be overestimated in our results.

**Affected claims**: A3 (Tier-1 dominance may be incomplete without IXP layer), A2 (Astoria effectiveness may be overestimated).

**Mitigation**: Neither RAPTOR nor Johnson et al. modeled IXPs, so this is a shared limitation rather than a reproduction-specific gap. The threat is documented as a limitation applicable to the entire line of research.

### 3.3 AS-Level Aggregation

**Threat**: All Tor relays within the same AS are aggregated into a single node. This obscures:
- Intra-AS diversity (relays in different data centers with different upstream providers)
- Operator diversity (multiple independent operators in the same AS)
- Bandwidth heterogeneity within an AS

**Potential impact**:
- Guard selection probabilities may differ from relay-level selection. An AS with many small relays would have the same aggregate bandwidth as an AS with one large relay, but the relay-level selection dynamics differ.
- Family grouping (Tor's MyFamily) is not considered, potentially overestimating the independence of relays within the same AS.

**Affected claims**: Minimal. AS-level aggregation is the standard abstraction for network-layer adversary analysis (both RAPTOR and Johnson et al. operate at this level).

**Mitigation**: This is a deliberate design choice shared with the original papers. Our data pipeline (`tor-anal/pipeline/`) computes AS-level aggregated bandwidths from individual relay data, preserving the total bandwidth accurately.

### 3.4 Topology Vintage (2025 vs 2013-2014)

**Threat**: Our CAIDA data covers 2025, while the original papers used 2013-2014 data. The Internet AS topology has evolved:
- AS connectivity patterns have changed (HE expanded peering, NTT's relative role decreased)
- Tor relay geographic distribution shifted toward European hosting providers
- New large hosting ASes have emerged (Hetzner, OVH growth)

**Potential impact**:
- **Rank ordering differences**: The shift from NTT #1 (2013) to HE #1 (2025) in threat rankings reflects genuine topology evolution, not a methodology error. However, it means our results are not directly comparable to the 2013-2014 snapshot.
- **Defense effectiveness temporal dependence**: Astoria's effectiveness may vary as the AS topology evolves and new transit paths emerge.

**Affected claims**: A3 (specific rank positions differ from paper, though Tier-1 dominance as a category is preserved).

**Mitigation**: The vintage difference is explicitly documented. Our results represent a 2025-era snapshot that can be compared to the 2013-era results to identify temporal trends in AS-level threats.

---

## 4. Construct Validity

Construct validity concerns whether our measurements actually capture the theoretical constructs they purport to measure.

### 4.1 Correlation Detection as Deanonymization Proxy

**Threat**: Our "traffic correlation" metric counts circuits where the same AS appears on both the entry path (client-to-guard) and the exit path (exit-to-destination). This is a necessary but not sufficient condition for actual traffic deanonymization:

1. **Timing analysis gap**: Even if an AS observes both entry and exit traffic, successful deanonymization requires timing correlation (matching packet arrival/departure patterns). We do not model timing analysis.
2. **Traffic volume requirement**: Low-volume traffic may be harder to correlate than high-volume traffic. We assume all correlated circuits are equally vulnerable.
3. **Encryption layer**: Tor's layered encryption means the observing AS sees encrypted traffic. While traffic analysis can often defeat this, it is not guaranteed.

**Potential impact**: Our correlation rates represent an **upper bound** on actual deanonymization capability. The true deanonymization rate is lower because:
- Not all correlated circuits would yield successful timing attacks
- Some ASes may not have the infrastructure or motivation to perform correlation
- Traffic mixing and padding (if deployed) would reduce effectiveness

**Affected claims**: All claims overestimate the adversary's *actual* capability but correctly measure *opportunity*. This is consistent with RAPTOR and Johnson et al., which use the same metric.

**Mitigation**: This threat is inherent to the research methodology shared with both original papers. We explicitly frame our results as measuring "correlation opportunity" rather than "successful deanonymization."

### 4.2 Static Adversary Model

**Threat**: Our adversary model assumes static adversary placement:
- Network adversary: fixed set of ASes with observation capability, determined at simulation start
- Relay adversary: fixed adversary relay configuration, no adaptive behavior
- No adversary resource constraints, no adversary intelligence gathering

**Potential impact**:
- A real adversary might **adaptively target** specific users by dynamically adjusting relay bandwidth, exploiting guard rotation windows, or launching targeted BGP attacks based on observed traffic patterns.
- Our results assume a **passive** adversary who observes all traffic through its ASes without actively manipulating the network (except for BGP attacks in specific scenarios). Active adversaries could achieve higher correlation rates.

**Affected claims**: All claims may underestimate the threat from adaptive adversaries. However, the static adversary model is the standard assumption in the original papers.

**Mitigation**: This is consistent with the original papers' threat model. Our results provide a **lower bound** on adaptive adversary capability: an adaptive adversary can always do at least as well as a static one.

### 4.3 Uniform Client-Destination Distribution

**Threat**: Our simulated clients select destinations uniformly at random from all exit-reachable ASes. Real Tor usage has highly skewed destination distributions:
- Popular websites (Google, Facebook, Wikipedia) concentrate traffic toward specific ASes
- Geographically biased traffic patterns (users tend to access services in their region)
- Different usage profiles (web browsing vs. messaging vs. file sharing) have different destination distributions

**Potential impact**:
- **Concentration effects**: If many clients access the same popular destinations, the adversary gains correlation advantage because the exit-side AS path is shared across many circuits, increasing the probability that the same transit AS observes multiple clients' traffic.
- **Geographic bias**: If users and destinations are geographically correlated, certain regional ASes may observe disproportionate traffic.

**Affected claims**: B1, B3 (temporal and attack effects may be stronger or weaker depending on destination concentration), A2 (defense effectiveness may vary with destination distribution).

**Mitigation**: The uniform distribution provides a conservative baseline. Validation with realistic traffic models (e.g., Alexa Top-1000 destination weighting) is future work.

---

## 5. Statistical Conclusion Validity

Statistical conclusion validity concerns whether the statistical methods and sample sizes support the conclusions drawn.

### 5.1 Sample Size: 50-Client Defense Experiments

**Threat**: The network defense comparison (Johnson et al. Set A) uses only 50 simulated clients.

**Potential impact**:
- **Wide confidence intervals**: For a 68% compromise rate (Vanilla), the Wilson 95% CI is [53.3%, 80.5%]. For an 18% rate (Astoria), the CI is [8.6%, 31.4%].
- **Indistinguishable scenarios**: Vanilla and Counter-RAPTOR both show 68% client compromise (34/50). With n=50, we cannot determine whether Counter-RAPTOR provides any client-level benefit.
- **CDF granularity**: Each client represents 2% of the CDF, producing coarse staircase plots.

**Affected claims**: A2 (the Vanilla vs. Counter-RAPTOR comparison at the client level is statistically indeterminate).

**Mitigation**:
1. The stream-level comparison (1.93% vs. 1.84%, based on 1,944,150 circuits) provides much higher statistical power and confirms Counter-RAPTOR's modest effect.
2. The Astoria vs. Vanilla gap (18% vs. 68%) is highly significant even with n=50 (Fisher exact test p < 0.001).
3. Planned S2 simulations will increase client count to 200+.

### 5.2 Observation Period: 90-180 Days

**Threat**: Experiments span 90 days (RAPTOR R1, R3, R4) or 180 days (RAPTOR R2, relay adversary). This covers:
- 3 CAIDA topology snapshots (90 days) or 7 snapshots (180 days)
- 1-3 BGP attack events (each lasting 7 days)
- 1-2 guard rotation cycles

**Potential impact**:
- **Guard rotation coverage**: With U(30, 60) guard lifetimes, 90 days covers only 1.5-3 rotations. The relay adversary experiment (180 days) adequately covers the rotation cycle, but the 90-day RAPTOR experiments may not capture second-rotation effects.
- **Seasonal BGP patterns**: Internet routing exhibits seasonal patterns (holiday traffic shifts, year-end network upgrades). Our 90-180 day window may not be representative of annual patterns.
- **Long-term convergence**: The temporal churn experiment (B1) shows a trend over 6 months. Whether this trend continues, plateaus, or reverses beyond 6 months is unknown.

**Affected claims**: B1 (trend extrapolation beyond 6 months is speculative).

**Mitigation**: The 180-day window for temporal experiments is comparable to RAPTOR's 90-day window (with finer temporal resolution in the original). The observation that 100% relay compromise occurs by day 60 means the relay adversary experiment has adequate coverage (180 days >> 60 days).

### 5.3 Multiple Comparisons

**Threat**: We evaluate multiple claims (A1-A3, B1-B3, C1-C2) from the same experimental data without formal correction for multiple testing.

**Potential impact**: With 8 claims evaluated, the probability that at least one "passes" by chance (at alpha = 0.05) is approximately 1 - (1-0.05)^8 = 33.7%. However, our claims are not independent hypothesis tests but rather qualitative assessments of different metrics.

**Affected claims**: All, but the risk is low because:
1. Tier A claims have very large effect sizes that are far beyond any reasonable alpha threshold
2. Tier B claims are explicitly labeled as conditional
3. Tier C claims are structural limitations, not statistical inferences

**Mitigation**: We do not perform formal hypothesis testing with alpha thresholds. Instead, we use a qualitative tier system that accounts for effect size magnitude. Multi-seed runs (S1/S2) will provide variance estimates that enable formal testing if desired.

### 5.4 Non-Independence of Circuits

**Threat**: Circuits from the same client share the same guard relay (within the guard lifetime), creating correlated outcomes. Treating all circuits as independent (as in computing binomial confidence intervals) overestimates statistical precision.

**Potential impact**:
- The effective sample size for correlation rate estimation is smaller than the raw circuit count. If 200 clients each generate 38,880 circuits (90 days * 432 circuits/day), and circuits within a client are correlated due to shared guards, the effective sample size may be closer to 200 (client count) than 7,776,600 (circuit count).
- This inflates apparent statistical significance of small differences (e.g., the 2.577% vs. 2.584% asymmetric routing comparison).

**Affected claims**: B2 (the 1.003x factor may not be distinguishable from 1.0 after accounting for within-client correlation).

**Mitigation**:
1. Validation scripts should compute per-client correlation rates and report client-level means with standard errors (n = 200 or 500 independent observations per experiment).
2. Multi-seed runs provide additional independent samples beyond within-experiment circuits.

---

## 6. Summary of Threats and Mitigations

| # | Threat | Category | Severity | Affected Claims | Mitigation |
|---|--------|----------|----------|-----------------|------------|
| 2.1 | Single random seed | Internal | Critical | All (esp. B1-B3) | S1/S2 multi-seed |
| 2.2 | Deterministic BFS routing | Internal | High | B1, B2 | Stochastic relay selection provides diversity |
| 2.3 | Simplified guard model | Internal | Medium | A1 (CDF shape) | S3 variable lifetimes |
| 2.4 | Circuit independence | Internal | Low | Aggregate rates | Guard persistence modeled |
| 3.1 | Reduced topology (727 vs 48K) | External | High | C1, C2, B2 | Relative claims only; scaling analysis |
| 3.2 | Missing IXP layer | External | Medium | A3 | Shared limitation with original papers |
| 3.3 | AS-level aggregation | External | Low | Minimal | Design choice shared with papers |
| 3.4 | Topology vintage (2025 vs 2013) | External | Low | A3 ranks | Explicitly documented temporal shift |
| 4.1 | Correlation as deanonymization proxy | Construct | Medium | All (upper bound) | Standard metric in literature |
| 4.2 | Static adversary model | Construct | Medium | All (lower bound) | Standard assumption in papers |
| 4.3 | Uniform destination distribution | Construct | Low | B1, B3, A2 | Conservative baseline |
| 5.1 | 50-client defense experiments | Statistical | Medium | A2 (CR vs Vanilla) | S2 with 200+ clients |
| 5.2 | 90-180 day observation period | Statistical | Low | B1 trend extrapolation | Adequate for primary findings |
| 5.3 | Multiple comparisons | Statistical | Low | All | Qualitative tier system, not p-values |
| 5.4 | Non-independent circuits | Statistical | Medium | B2 | Per-client aggregation in V-scripts |

---

## 7. Overall Validity Assessment

### Threats that do NOT invalidate our conclusions:
- **Internal**: Deterministic BFS (2.2), simplified guard model (2.3), and circuit independence (2.4) affect specific aspects of the results but do not invalidate the primary claim classification. The stochastic relay selection process provides sufficient randomization for aggregate metrics.
- **External**: AS-level aggregation (3.3) and topology vintage (3.4) are low-severity threats. Missing IXPs (3.2) is a shared limitation with the original papers.
- **Construct**: Both construct threats (4.1, 4.2) bound our results in known directions (overestimate opportunity, underestimate adaptive adversary). The uniform destination distribution (4.3) provides a conservative baseline.
- **Statistical**: Observation period (5.2) and multiple comparisons (5.3) are adequately addressed by the experimental design.

### Threats that require mitigation before publication:
1. **Single seed (2.1)**: Critical. Must be resolved by multi-seed simulations with confidence intervals.
2. **50-client experiments (5.1)**: Must be addressed to distinguish Counter-RAPTOR from Vanilla at the client level.
3. **Non-independent circuits (5.4)**: Must be addressed by per-client aggregation in analysis scripts.

### Threats that are acknowledged limitations:
1. **Topology scale (3.1)**: Cannot be fully resolved without architectural changes. Framing all claims as relative comparisons mitigates this.
2. **BFS routing (2.2)**: Cannot be fully resolved without BGP RIB integration. The direction of the bias is known and documented.

### Net assessment:
Our Tier A claims (relay compromise mechanics, defense ordering, Tier-1 dominance) are **robust** against all identified threats. Tier B claims (temporal churn, asymmetric routing, BGP attack impact) require multi-seed confirmation but are directionally correct. Tier C limitations (interception ineffectiveness, absolute value gaps) are appropriately classified as structural constraints that no amount of additional simulation with the current architecture can resolve.
