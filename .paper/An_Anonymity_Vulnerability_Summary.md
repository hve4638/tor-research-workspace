# An Anonymity Vulnerability in Tor

**요약 작성일**: 2026-02-21
**원문**: Tan, Wang, Shi, Tang, Tian (IEEE/ACM Transactions on Networking, 2022)
**소속**: Guangzhou University / Chinese Academy of Sciences / Carleton University / Midea Group
**DOI**: 10.1109/TNET.2022.3174003

---

## 1. 핵심 기여 (One-line)

Honey relay 주입과 선택적 DoS를 결합한 **Trapper Attack**을 제안하여, Tor의 경로 선택을 확률적(probabilistic)에서 결정적(deterministic)으로 전환시킴으로써 **40초 이내 100% 정확도**로 실시간 deanonymization을 달성한 논문.

---

## 2. 연구 동기

- 기존 end-to-end 트래픽 상관 공격은 적대자가 통신 양 끝점을 **이미 관찰할 수 있다고 가정** — 현실적으로 달성하기 어려움
- Tor의 guard 메커니즘(120일 고정 guard list)이 적대자의 entry 노드 장악을 어렵게 만듦
- 기존 연구의 한계:
  - 적대자가 다수의 AS를 통제해야 하는 비현실적 가정
  - Tor 네트워크의 7000+ 릴레이와 지리적 분산으로 양 끝점 동시 관찰이 실질적으로 곤란
  - 검출 시스템(Sybilhunter, DannerDetector)에 의한 악성 릴레이 탐지 가능성 미고려
- **핵심 관찰**: 적대자가 직접 양 끝점을 관찰하는 것이 아니라, **honey relay를 주입하고 선택적 DoS로 사용자를 유도**하면 경로를 장악할 수 있음

---

## 3. 공격 방법 (Trapper Attacks)

### 3.1 위협 모델 (Threat Model)

| 적대자 유형 | 능력 |
|-----------|------|
| **Node-level** | 자체 Tor 릴레이 운영 또는 기존 릴레이와 공모 |
| **AS-level** | 하나 이상의 AS를 통제, 트래픽 관찰/변경/차단 가능 |

- 적대자는 honey relay(고대역폭, 고가동시간)를 Tor 네트워크에 주입
- 검열 네트워크(예: 중국 GFW)의 간헐적 장애를 활용하여 entry guard를 선택적으로 차단
- 기존 네트워크 프로토콜은 안전하다고 가정, honey relay 수만 제한됨

### 3.2 Basic Trapper Attack

#### Guard Relay Capture (GRC) Attack
1. 타겟 사용자의 entry guard를 식별 (DPI, TLS 핑거프린트, active probing)
2. 사용자가 adversarial relay를 guard로 선택했는지 확인
3. 선택하지 않았으면 해당 guard 연결을 **선택적으로 차단**
4. Tor 클라이언트가 새 guard를 선택하도록 유도
5. Honey relay가 선택될 때까지 반복

> Guard list 업데이트 간격: **3~6개월 → 평균 3분으로 단축**

#### Tor Circuit Selective Destruction (TCSD) Attack
- Guard 장악 후 exit 노드도 장악하기 위한 공격
- Honey guard에서 `CMD_INTERRUPT` 명령으로 현재 회로를 파괴
- 회로 파괴 방법 2가지:
  1. 데이터 셀의 랜덤 비트 변조 → 복호화 실패 유발
  2. `CMD_DESTROY` 셀 직접 전송 → 회로 재귀적 파괴
- Exit이 honey relay가 될 때까지 반복 → **entry + exit 모두 장악**

### 3.3 Advanced Trapper Attack (탐지 우회)

3가지 anti-detection 전술:

#### (1) Obfuscating Deployment (Sybilhunter 우회)
- **외형 난독화**: IP 주소(다양한 VPS: AWS, Azure, Linode), 닉네임, 포트, 소프트웨어 버전을 랜덤화
- **행동 난독화**: Poisson 분포를 사용하여 uptime 랜덤화
  - `lambda = lambda_stable - lambda_float` (5일 평균 - 3시간 평균)
  - 시간당 실행할 릴레이 수가 Poisson 분포를 따르도록 설정

#### (2) Deferral Decision (DannerDetector 우회)
- 회로 중단 결정을 랜덤 시간 `wt` 만큼 지연 (`wt_min < wt < wt_max`)
- 중단된 테스트 회로들의 lifetime이 균일하지 않게 되어 탐지 회피

#### (3) Collaborative Filtering (DannerDetector 우회)
- 모든 honey relay가 협력하여 회로 패턴 이력(`list_hist`)을 공유
- 유사 패턴(동일 guard/exit + Pearson 상관계수 > 0.7) 발견 시 중단 확률을 절반으로 감소:
  - `p_dropping = p_dropping / 2^count` (비침해 회로)
  - `p_accepting = p_accepting / 2^count` (침해 회로)
- 3가지 시나리오별 적응적 대응 (guard+exit 모두 honey / 모두 정상 / 하나만 honey)

### 3.4 Deanonymization 시스템 아키텍처

3개 핵심 모듈:
1. **Circuit Controller**: 회로 파괴 여부 결정 + `CMD_INTERRUPT` 전송
2. **Fast Traffic Analysis**: 회로별 핑거프린트(cell count, throughput, type, direction, circuit ID) 추출
3. **Traffic Correlation**: 2단계 상관 분석
   - 1단계: 회로 구축 타이밍/패턴으로 잠재적 origin-destination 쌍 식별
   - 2단계: throughput 핑거프린팅 + Pearson 상관계수(임계값 t=0.7)로 최종 매칭

---

## 4. 방법론

### 4.1 실험 환경
- Tor-0.4.0.5 소스코드 수정하여 회로 정보 로깅
- **10개 관측 지점**, 각 지점에서 **20개 Tor 클라이언트** 동시 실행
- Honey relay 수: 10, 20, 50, 100, 150, 200개로 변경하며 테스트
- Linux iptables로 relay selection hijacking 시뮬레이션

### 4.2 Guard/Exit 선택 확률 모델

Guard 선택 확률:
```
P_G(b) = b / (B_G + B_GE * W_E)
```

Exit 선택 확률:
```
P_E(b_hat) = b_hat / (B_E + B_GE * W_G)
```

n회 guard 업데이트 후 최소 1회 honey guard 선택 확률:
```
P_G(B, n) = 1 - (1 - P_G(B))^n
```

Entry + Exit 동시 침해 확률:
```
P_{n,m}(B, B_hat) = P_G(B, n) * P_E(B_hat, m)
```

### 4.3 Deanonymization 정확도 실험
- **실제 Tor 네트워크**에서 7개 관측 지점으로 테스트
- 3종 클라이언트: Web browsing(Alexa Top 500), IRC bot, Bulk transfer(Vuze BitTorrent)
- 3개 guard + 5개 exit honey relay 배치
- 회로 핑거프린트를 Kafka로 중앙 서버에 전송하여 분석
- Outlier 제거: 회로 전체 lifetime < 300초 또는 활성 시간 <= 3초

### 4.4 Anti-detection 평가
- **Sybilhunter**: 2020-01-01 ~ 2020-08-30 relay-descriptor 생성
  - 3종 데이터셋 비교: 원본 / obfuscating 미적용 honey / obfuscating 적용 honey
- **DannerDetector**: N=10,000, honey relay k=10~100개로 시뮬레이션
  - 3종 정책 비교: 전수 차단 / 확률적 차단(0.9) / deferral+collaborative filtering(0.9)

---

## 5. 주요 결과

### 5.1 Trapper Attack 효과

| 메트릭 | 결과 |
|--------|------|
| Deanonymization 정확도 | **100%** (40초 이내) |
| False positive rate | **~0%** (1% 미만) |
| Guard list 업데이트 간격 | 3~6개월 → **평균 3분** |
| 100 guard + 20 exit 배치 시 | 400회 회로 생성 시도 후 **90% 확률**로 경로 침해 |
| 4시간 이내 deanonymization | 적대자 통제 지역 사용자 **~100%** |

### 5.2 Guard/Exit 침해 확률

- 100개 guard 통제 시: **47회** 회로 생성 차단으로 첫 honey guard 선택
- Guard 수 증가에 따른 첫 침해 guard 선택 확률: 200개 guard → ~9.5%
- Exit 침해: 통제 exit 수에 비례하여 회로 rotation 횟수 감소 (200개 exit → ~250회)

### 5.3 Anti-detection 성능

**Sybilhunter 우회**:
| 월 | 주입 릴레이 | Trapper Attack 생존율 | 미적용 생존율 |
|----|-----------|---------------------|------------|
| 2020-01 | 209 | 95.20% | 5.74% |
| 2020-02 | 195 | 92.80% | 5.13% |
| 2020-03 | 219 | 93.60% | 6.85% |
| 평균 | 209/월 | **94.28%** | **5.58%** |

**DannerDetector 우회**:
- Collaborative filtering 적용 시 lifetime이:
  - 확률적 차단 대비 **~85배** 증가 (100 honey relay)
  - 전수 차단 대비 **~235배** 증가

### 5.4 트래픽 유형별 결과
- Web browsing: 30초 내 100% 정확도 도달
- IRC: 약 20초 내 100% 정확도 도달
- Bulk transfer: 약 25초 내 100% 정확도 도달
- 모든 유형에서 FPR < 1% (30초 이후)

---

## 6. 방어 제안

| 방어 | 설명 |
|------|------|
| **Guard 노출 제한** | 일정 기간 내 선택 가능한 guard 수를 제한하여 adversarial guard 선택 확률 감소 |
| **우회 도구 사용** | Tor over VPN으로 공격자가 Tor 트래픽 자체를 볼 수 없게 암호화 |
| **릴레이 행동 모니터링** | 평판 시스템으로 비정상적 릴레이(잦은 회로 파괴 등) 탐지 |

> 핵심 과제: 회로 파괴가 의도적인지 네트워크 장애인지 구분하기 어려움

---

## 7. 프로젝트 연관성

이 논문은 본 프로젝트(project-tor)의 **능동적 공격 모델**과 **Sybil 방어**에 대한 보완적 관점을 제공:

| 논문 개념 | 프로젝트 구현 |
|----------|-------------|
| AS-level 적대자의 선택적 경로 조작 | `next-simulate/internal/bgp/` — BGP hijack/interception 시뮬레이션 |
| Guard relay 장악 (GRC Attack) | `next-simulate/internal/circuit/` — Guard 선택 알고리즘 (대역폭 가중치 기반) |
| Selective DoS를 통한 회로 파괴 | `next-simulate/internal/adversary/` — 4종 적대자 모델 (SingleAS, Colluding, StateLevel, Tier1) |
| Honey relay 주입 + 대역폭 조작 | `configs/bgp_attack.yaml` — 공격 시나리오 설정 |
| End-to-end 트래픽 상관 | `tor-anal/analysis/` — 상관율 계산, Pearson 상관계수 기반 분석 |
| Guard 업데이트 메커니즘 악용 | `next-simulate/internal/directory/` — 디렉토리 서비스, guard 만료/갱신 로직 |
| Anti-detection (Sybilhunter 우회) | 현재 미구현 — Sybil 탐지/방어는 프로젝트 범위 외 |
| Counter-RAPTOR 방어 | `next-simulate/internal/defense/` — resilience 기반 guard 재가중치 (M6 구현) |
| Astoria 방어 | `configs/astoria_defense.yaml` — entry/exit transit AS 교집합 검사 (M6 구현) |

### 본 논문과 프로젝트의 관계

- **프로젝트의 수동적 관찰자 모델을 보완**: 프로젝트는 AS-level 글로벌 관찰자의 수동적(passive) 트래픽 상관에 집중하는 반면, 본 논문은 **능동적(active) 경로 조작**으로 관찰 위치를 확보하는 방법을 제시
- **RAPTOR 논문과의 차이**: RAPTOR는 BGP hijack/interception으로 기존 경로를 변경하지만, Trapper Attack은 **Tor 내부 메커니즘(guard 갱신, 회로 파괴)**을 악용
- **방어 전략 시사점**: Counter-RAPTOR와 Astoria는 AS 경로 기반 방어이므로, Trapper Attack처럼 **릴레이 자체를 장악하는 공격**에는 직접적으로 대응하지 못함 → 추가 방어 메커니즘 필요

---

## 8. 한계 및 후속 연구

- **실험 규모 제한**: 실제 Tor 네트워크에서 실험했으나, 10개 관측 지점 × 20 클라이언트로 제한
- **검열 네트워크 가정**: GFW처럼 트래픽을 차단할 수 있는 AS-level 적대자를 가정 — 비검열 국가에서의 적용 가능성은 불명확
- **Tor 버전 의존**: Tor-0.4.0.5 기반 — 이후 버전의 guard 메커니즘 변경(Proposal 271 등) 미반영
- **탐지 시스템 한계**: Sybilhunter와 DannerDetector만 고려 — 새로운 탐지 기법에 대한 내성 미평가
- **I2P, Freenet 등 타 익명 네트워크**에 대한 적용은 향후 연구로 남겨둠
- **방어 제안이 개념적 수준**: 구체적 구현이나 정량적 효과 분석 없음
- **윤리적 고려**: 실제 Tor 네트워크에서 실험하여 실사용자에 영향을 줄 수 있음 (논문에서 완화 조치 언급 없음)

---

## 9. 참고 수치 요약

```
Trapper Attack 성능:
  - Deanonymization 정확도: 100% (40초 이내)
  - False Positive Rate: ~0% (1% 미만)
  - Guard list 업데이트 강제 단축: 3-6개월 → 평균 3분

Guard 침해:
  - 100 guard 통제 시: 47회 차단으로 첫 honey guard 선택
  - Guard 선택 확률: P_G(b) = b / (B_G + B_GE * W_E)

경로 침해 (100 guard + 20 exit):
  - 400회 회로 생성 시도 → 90% 확률로 guard+exit 동시 침해
  - 4시간 이내 → 통제 지역 사용자 ~100% deanonymization

Anti-detection (Sybilhunter):
  - 월 평균 209개 honey relay 주입
  - Obfuscating 적용 생존율: 94.28%
  - Obfuscating 미적용 생존율: 5.58%

Anti-detection (DannerDetector):
  - Collaborative filtering lifetime: 전수 차단 대비 ~235배

실험 환경:
  - Tor-0.4.0.5 수정 버전
  - 10 관측 지점 × 20 클라이언트
  - 3 guard + 5 exit honey relay (정확도 실험)
  - 2020년 Tor 네트워크 데이터 기반
```
